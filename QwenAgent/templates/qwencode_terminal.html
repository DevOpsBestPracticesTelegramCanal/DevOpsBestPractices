<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QwenCode</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" href="/static/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            /* Claude Code exact color scheme */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --bg-input: #0d1117;

            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;

            --accent-orange: #f78166;
            --accent-yellow: #d29922;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-red: #f85149;
            --accent-cyan: #39c5cf;

            --border-color: #30363d;
            --border-focus: #58a6ff;

            /* Diff colors */
            --diff-added-bg: #1a4721;
            --diff-added-border: #238636;
            --diff-added-text: #7ee787;
            --diff-removed-bg: #4c1d1d;
            --diff-removed-border: #da3633;
            --diff-removed-text: #ffa198;

            /* Code block */
            --code-bg: #161b22;
            --code-border: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========== HEADER ========== */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
            box-shadow: 0 2px 8px rgba(163, 113, 247, 0.3);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-version {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Status indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(63, 185, 80, 0); }
        }

        .status-dot.offline {
            background: var(--accent-red);
            animation: none;
        }

        /* Model selector */
        .model-selector {
            position: relative;
        }

        .model-badge {
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--accent-cyan);
            border: 1px solid var(--border-color);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-badge:hover {
            border-color: var(--accent-cyan);
            background: var(--bg-hover);
        }

        .model-badge-arrow {
            font-size: 8px;
            transition: transform 0.15s;
        }

        .model-selector.open .model-badge-arrow {
            transform: rotate(180deg);
        }

        .model-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            min-width: 280px;
            max-height: 360px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            padding: 6px;
        }

        .model-selector.open .model-dropdown {
            display: block;
            animation: dropIn 0.15s ease-out;
        }

        @keyframes dropIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .model-dropdown-header {
            padding: 8px 10px 6px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .model-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.1s;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .model-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .model-item.active {
            background: rgba(57, 197, 207, 0.12);
            color: var(--accent-cyan);
        }

        .model-item-check {
            width: 16px;
            text-align: center;
            font-size: 14px;
        }

        .model-item-info {
            flex: 1;
            min-width: 0;
        }

        .model-item-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .model-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .model-dropdown-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Mode selector */
        .mode-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .mode-btn {
            background: transparent;
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mode-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .mode-btn.active {
            color: white;
        }

        .mode-btn.active.fast { background: var(--accent-green); }
        .mode-btn.active.deep { background: var(--accent-purple); }
        .mode-btn.active.search { background: var(--accent-blue); }
        .mode-btn.active.aisearch { background: var(--accent-orange); }

        /* ========== MODE BANNER ========== */
        .mode-banner {
            background: linear-gradient(90deg, rgba(163, 113, 247, 0.15), transparent);
            border-bottom: 1px solid rgba(163, 113, 247, 0.3);
            padding: 8px 20px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--accent-purple);
        }

        .mode-banner.active { display: flex; }
        .mode-banner.deep {
            background: linear-gradient(90deg, rgba(163, 113, 247, 0.15), transparent);
            border-color: rgba(163, 113, 247, 0.3);
            color: var(--accent-purple);
        }
        .mode-banner.search {
            background: linear-gradient(90deg, rgba(88, 166, 255, 0.15), transparent);
            border-color: rgba(88, 166, 255, 0.3);
            color: var(--accent-blue);
        }
        .mode-banner.aisearch {
            background: linear-gradient(90deg, rgba(227, 139, 46, 0.15), transparent);
            border-color: rgba(227, 139, 46, 0.3);
            color: var(--accent-orange);
        }

        /* ========== TERMINAL AREA ========== */
        .terminal-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .output {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        /* ========== MESSAGES ========== */
        .message {
            margin-bottom: 20px;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message-prompt {
            color: var(--accent-orange);
            font-weight: 700;
            font-size: 16px;
            line-height: 1.4;
        }

        .message-content {
            color: var(--text-primary);
            flex: 1;
        }

        .message-assistant {
            padding-left: 26px;
            border-left: 2px solid var(--border-color);
            margin-left: 8px;
            margin-top: 8px;
        }

        .message-system {
            color: var(--text-muted);
            font-size: 13px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* ========== TOOL CALLS ========== */
        .tool-call {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-orange);
            border-radius: 0 8px 8px 0;
            margin: 12px 0;
            overflow: hidden;
        }

        .tool-header {
            background: var(--bg-tertiary);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .tool-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .tool-name {
            color: var(--accent-green);
            font-weight: 600;
        }

        .tool-params {
            color: var(--text-muted);
            font-size: 12px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tool-status {
            font-size: 14px;
            font-weight: 600;
        }

        .tool-status.success { color: var(--accent-green); }
        .tool-status.error { color: var(--accent-red); }
        .tool-status.running { color: var(--accent-yellow); }

        .tool-result {
            padding: 12px 14px;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        /* ========== CODE BLOCKS ========== */
        .code-block-wrapper {
            position: relative;
            margin: 12px 0;
        }

        .code-block-header {
            background: var(--bg-tertiary);
            padding: 8px 14px;
            border: 1px solid var(--code-border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .code-block-lang {
            font-weight: 500;
        }

        .code-copy-btn {
            background: var(--bg-hover);
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .code-copy-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .code-copy-btn.copied {
            background: var(--accent-green);
            color: white;
        }

        pre {
            background: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 0 0 8px 8px;
            padding: 14px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
        }

        pre:only-child {
            border-radius: 8px;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        /* Inline code */
        :not(pre) > code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--accent-cyan);
        }

        /* ========== DIFF VIEW ========== */
        .diff-container {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 12px 0;
        }

        .diff-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diff-header-icon {
            color: var(--accent-yellow);
        }

        .diff-header-text {
            color: var(--accent-yellow);
            font-weight: 500;
        }

        .diff-header-file {
            color: var(--text-primary);
            margin-left: 4px;
        }

        .diff-stats {
            margin-left: auto;
            display: flex;
            gap: 8px;
            font-size: 12px;
        }

        .diff-stats-added { color: var(--diff-added-text); }
        .diff-stats-removed { color: var(--diff-removed-text); }

        .diff-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .diff-line {
            display: flex;
            line-height: 1.6;
            min-height: 24px;
        }

        .diff-line-number {
            width: 42px;
            min-width: 42px;
            color: var(--text-muted);
            text-align: right;
            padding: 0 6px;
            user-select: none;
            background: rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        .diff-line-number + .diff-line-number {
            border-right: 1px solid var(--border-color);
        }

        .diff-line-sign {
            width: 24px;
            min-width: 24px;
            text-align: center;
            font-weight: 700;
        }

        .diff-line-content {
            flex: 1;
            padding: 0 12px;
            white-space: pre;
            overflow-x: auto;
        }

        /* Syntax highlighting inside diffs ‚Äî preserve diff bg */
        .diff-line-content code.hljs {
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            display: inline;
            font-size: inherit;
            line-height: inherit;
        }

        .diff-line.diff-added {
            background: var(--diff-added-bg);
        }
        .diff-line.diff-added .diff-line-sign { color: var(--diff-added-text); }
        .diff-line.diff-added .diff-line-number { background: rgba(35, 134, 54, 0.2); }

        .diff-line.diff-removed {
            background: var(--diff-removed-bg);
        }
        .diff-line.diff-removed .diff-line-sign { color: var(--diff-removed-text); }
        .diff-line.diff-removed .diff-line-number { background: rgba(218, 54, 51, 0.2); }

        .diff-line.diff-context .diff-line-sign {
            color: var(--text-muted);
        }

        .diff-separator {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-size: 11px;
            padding: 2px 12px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            user-select: none;
        }

        /* ========== THINKING BLOCK ========== */
        .thinking-block {
            background: rgba(163, 113, 247, 0.08);
            border: 1px solid rgba(163, 113, 247, 0.25);
            border-radius: 8px;
            padding: 12px 14px;
            margin: 12px 0;
            font-size: 13px;
        }

        .thinking-header {
            color: var(--accent-purple);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .thinking-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ========== CHOICES / CONFIRMATION ========== */
        .choices-container {
            margin: 16px 0;
            padding: 16px;
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            background: rgba(210, 153, 34, 0.08);
        }

        .choices-question {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .choices-question::before {
            content: "?";
            background: var(--accent-yellow);
            color: var(--bg-primary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .choice-item {
            padding: 8px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .choice-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .choice-item.choice-active {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .choice-marker {
            font-weight: 700;
            width: 16px;
        }

        .choice-number {
            color: var(--text-muted);
            font-size: 12px;
        }

        .choice-shortcut {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: auto;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .choices-hint {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 12px;
        }

        /* ========== LOADING ========== */
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .loading-text.status-executing { color: var(--accent-orange); }
        .loading-text.status-executing::before { content: "‚ö°"; }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-orange);
            border-radius: 50%;
            display: inline-block;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .loading-step-counter {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: 4px;
        }

        /* ========== INPUT AREA ========== */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            transition: border-color 0.15s;
        }

        .input-wrapper:focus-within {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }

        .input-prompt {
            color: var(--accent-orange);
            font-weight: 700;
            font-size: 16px;
            padding-top: 2px;
        }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
        }

        #input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn {
            background: var(--accent-blue);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .send-btn:hover {
            background: #4393e6;
            transform: translateY(-1px);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stop-btn {
            background: var(--accent-red);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            display: none;
        }

        .stop-btn:hover {
            background: #da3633;
            transform: translateY(-1px);
        }

        .stop-btn.visible {
            display: inline-block;
        }

        .shortcut-hint {
            font-size: 11px;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        /* ========== ROUTE BADGE ========== */
        .route-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .route-badge.pattern {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .route-badge.llm {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent-blue);
        }

        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-hover);
        }

        /* ========== FULLSCREEN / PWA BUTTONS ========== */
        .header-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-purple);
        }

        #install-btn {
            display: none;
            color: var(--accent-green);
            border-color: var(--accent-green);
        }

        #install-btn:hover {
            background: rgba(63, 185, 80, 0.15);
        }

        /* ========== COMPACT MODE ========== */
        body.compact-mode .header {
            padding: 4px 12px;
        }

        body.compact-mode .logo-icon {
            width: 28px;
            height: 28px;
            font-size: 16px;
            border-radius: 7px;
        }

        body.compact-mode .logo-version {
            display: none;
        }

        body.compact-mode .output {
            padding: 10px 14px;
        }

        body.compact-mode .input-area {
            padding: 8px 12px;
        }

        body.compact-mode .input-wrapper {
            padding: 8px 12px;
        }

        body.compact-mode .message {
            margin-bottom: 12px;
        }

        /* Auto-compact in standalone PWA mode */
        @media (display-mode: standalone) {
            body { /* auto-apply compact via JS */ }
        }

        /* Fullscreen overrides */
        :fullscreen body,
        :-webkit-full-screen body {
            /* compact is applied via JS, this ensures background fills */
            background: var(--bg-primary);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .header { padding: 10px 12px; }
            .output { padding: 12px; }
            .input-area { padding: 12px; }
            .logo-text { font-size: 16px; }
            .header-controls { gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">Q</div>
            <div>
                <div class="logo-text">QwenCode</div>
                <div class="logo-version">v1.1.0 ‚Ä¢ Claude Code Style</div>
            </div>
        </div>
        <div class="header-controls">
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Connected</span>
            </div>
            <div class="model-selector" id="model-selector">
                <div class="model-badge" id="model-badge" title="Click to switch model">
                    <span id="model-name">qwen2.5-coder</span>
                    <span class="model-badge-arrow">‚ñº</span>
                </div>
                <div class="model-dropdown" id="model-dropdown">
                    <div class="model-dropdown-header">Available Models</div>
                    <div id="model-list">
                        <div class="model-dropdown-loading">Loading models...</div>
                    </div>
                </div>
            </div>
            <div class="mode-selector">
                <button class="mode-btn fast active" id="mode-fast" title="Fast mode (‚ö°)">‚ö° Fast</button>
                <button class="mode-btn deep" id="mode-deep" title="Deep CoT mode (üß†)">üß† Deep</button>
                <button class="mode-btn search" id="mode-search" title="Quick web search (üåê)">üåê Search</button>
                <button class="mode-btn aisearch" id="mode-aisearch" title="Search + AI analysis (üîç)">üîç AI+Search</button>
            </div>
            <button class="header-btn" id="install-btn" title="Install as desktop app">Install</button>
            <button class="header-btn" id="fullscreen-btn" title="Toggle fullscreen (F11)">&#x26F6;</button>
        </div>
    </div>

    <div class="mode-banner" id="mode-banner">
        <span id="mode-banner-icon">üß†</span>
        <span id="mode-banner-text">Deep Mode - Chain-of-Thought reasoning enabled</span>
    </div>

    <div class="terminal-container">
        <div class="output" id="output">
            <div class="message message-system">
                <strong>QwenCode Terminal</strong> ‚Äî Local AI coding assistant<br>
                Type <code>/help</code> for commands ‚Ä¢ <code>Ctrl+Enter</code> to send
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <span class="input-prompt">‚ùØ</span>
                <textarea id="input" placeholder="Ask anything or enter a command..." rows="1"></textarea>
                <div class="input-actions">
                    <span class="shortcut-hint">Ctrl+‚Üµ</span>
                    <button class="send-btn" id="send-btn">Send</button>
                    <button class="stop-btn" id="stop-btn" title="Stop request (Esc)">‚èπ Stop</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DOM ELEMENTS ==========
        const output = document.getElementById('output');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const modelBadge = document.getElementById('model-badge');
        const modeBanner = document.getElementById('mode-banner');
        const modeBannerIcon = document.getElementById('mode-banner-icon');
        const modeBannerText = document.getElementById('mode-banner-text');

        // Mode buttons
        const modeFast = document.getElementById('mode-fast');
        const modeDeep = document.getElementById('mode-deep');
        const modeSearch = document.getElementById('mode-search');
        const modeAiSearch = document.getElementById('mode-aisearch');

        // ========== STATE ==========
        let isProcessing = false;
        let currentMode = 'fast';
        let pendingConfirmation = null;
        let selectedChoiceIndex = 0;
        let abortController = null;

        // Stop button
        const stopBtn = document.getElementById('stop-btn');

        // ========== TOOL ICONS ==========
        const TOOL_ICONS = {
            'read': 'üìñ', 'write': '‚úèÔ∏è', 'edit': 'üîß', 'ls': 'üìÅ',
            'bash': 'üíª', 'grep': 'üîç', 'glob': 'üîç', 'search': 'üîç',
            'git': 'üì¶', 'web_fetch': 'üåê', 'web_search': 'üåê',
            'tree': 'üå≥', 'diff': 'üìä', 'notebook_read': 'üìì',
            'notebook_edit': 'üìì', 'default': '‚ö°'
        };

        // ========== TOOL LABELS (for live activity) ==========
        const TOOL_LABELS = {
            'read': 'Reading file',
            'write': 'Writing file',
            'edit': 'Editing file',
            'bash': 'Running command',
            'ls': 'Listing directory',
            'grep': 'Searching',
            'glob': 'Finding files',
            'git': 'Git operation',
            'tree': 'Showing tree',
            'web_fetch': 'Fetching URL',
            'web_search': 'Searching web',
            'diff': 'Comparing files'
        };

        // ========== INPUT HANDLING ==========
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // ========== MODE SWITCHING ==========
        modeFast.addEventListener('click', () => switchMode('fast'));
        modeDeep.addEventListener('click', () => switchMode('deep'));
        modeSearch.addEventListener('click', () => switchMode('search'));
        modeAiSearch.addEventListener('click', () => switchMode('aisearch'));

        function switchMode(mode) {
            currentMode = mode;

            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');

            // Update banner
            if (mode === 'fast') {
                modeBanner.classList.remove('active');
            } else {
                modeBanner.classList.add('active');
                modeBanner.className = `mode-banner active ${mode}`;

                if (mode === 'deep') {
                    modeBannerIcon.textContent = 'üß†';
                    modeBannerText.textContent = 'Deep Mode ‚Äî Chain-of-Thought reasoning enabled';
                } else if (mode === 'search') {
                    modeBannerIcon.textContent = 'üåê';
                    modeBannerText.textContent = 'Search Mode ‚Äî Fast web search (direct results, ~3 sec)';
                } else if (mode === 'aisearch') {
                    modeBannerIcon.textContent = 'üîç';
                    modeBannerText.textContent = 'AI+Search Mode ‚Äî Web search + LLM analysis';
                }
            }

            // Always sync mode with backend
            const modeMap = { 'fast': 'fast', 'deep': 'deep', 'search': 'fast', 'aisearch': 'search' };
            fetch('/api/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: modeMap[mode] || 'fast' })
            }).catch(() => {});
        }

        // ========== UPDATE LOADING ==========
        function updateLoading(id, text) {
            const el = document.getElementById(id);
            if (el) {
                const textEl = el.querySelector('.loading-text');
                if (textEl) textEl.textContent = text;
            }
        }

        // ========== SEND MESSAGE (SSE STREAMING) ==========
        async function sendMessage() {
            const message = input.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;
            stopBtn.classList.add('visible');
            input.value = '';
            input.style.height = 'auto';

            // Create AbortController for this request
            abortController = new AbortController();

            // Add mode prefix if needed
            let finalMessage = message;
            if (currentMode === 'deep' && !message.toUpperCase().startsWith('[DEEP]')) {
                finalMessage = `[DEEP] ${message}`;
            } else if (currentMode === 'search' && !message.startsWith('/search ')) {
                finalMessage = `/search ${message}`;
            } else if (currentMode === 'aisearch' && !message.toUpperCase().startsWith('[SEARCH]')) {
                finalMessage = `[SEARCH] ${message}`;
            }

            addMessage('user', message);
            const loadingId = showLoading('Processing...');

            let stepCount = 0;
            let totalSteps = 0;
            let hasToolCalls = false;
            let lastRouteMethod = '';

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: finalMessage }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process complete SSE lines
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;

                        let event;
                        try {
                            event = JSON.parse(line.slice(6));
                        } catch (e) {
                            continue;
                        }

                        switch (event.event) {
                            case 'status':
                                updateLoading(loadingId, event.text);
                                break;

                            case 'tool_start':
                                stepCount++;
                                totalSteps++;
                                const label = TOOL_LABELS[event.tool] || event.tool;
                                const fileHint = event.params?.file_path
                                    ? ` ${event.params.file_path}` : '';
                                updateLoading(loadingId,
                                    `[${stepCount}] ${label}${fileHint}...`);
                                break;

                            case 'tool_result':
                                hasToolCalls = true;
                                addToolCall({
                                    tool: event.tool,
                                    params: event.params,
                                    result: event.result
                                });
                                break;

                            case 'thinking':
                                if (event.steps && event.steps.length > 0) {
                                    addThinking(event.steps);
                                }
                                break;

                            case 'response':
                                lastRouteMethod = event.route_method || '';
                                hideLoading(loadingId);
                                if (event.text) {
                                    // Show response for: no tools, llm, deep_search, pattern+llm_analysis
                                    const showResponse = !hasToolCalls ||
                                        lastRouteMethod === 'llm' ||
                                        lastRouteMethod === 'deep_search' ||
                                        lastRouteMethod === 'pattern+llm_analysis';
                                    if (showResponse) {
                                        addMessage('assistant', event.text, lastRouteMethod);
                                    }
                                }
                                break;

                            case 'error':
                                hideLoading(loadingId);
                                addMessage('system', `Error: ${event.text || 'Unknown error'}`);
                                break;

                            case 'done':
                                hideLoading(loadingId);
                                break;
                        }
                    }
                }

                // Ensure loading is hidden
                hideLoading(loadingId);

            } catch (error) {
                hideLoading(loadingId);
                if (error.name === 'AbortError') {
                    addMessage('system', 'Request stopped by user');
                } else {
                    // Fallback to non-streaming API
                    console.warn('SSE failed, falling back to /api/chat:', error.message);
                    await sendMessageFallback(finalMessage, message, loadingId);
                }
            }

            isProcessing = false;
            sendBtn.disabled = false;
            stopBtn.classList.remove('visible');
            abortController = null;
            input.focus();
        }

        // ========== FALLBACK (non-streaming) ==========
        async function sendMessageFallback(finalMessage, originalMessage, loadingId) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: finalMessage })
                });

                const data = await response.json();
                hideLoading(loadingId);

                if (data.success) {
                    if (data.thinking && data.thinking.length > 0) {
                        addThinking(data.thinking);
                    }

                    const hasToolCalls = data.tool_calls && data.tool_calls.length > 0;
                    if (hasToolCalls) {
                        for (const tc of data.tool_calls) {
                            addToolCall(tc);
                        }
                    }

                    if (!hasToolCalls && data.response) {
                        addMessage('assistant', data.response, data.route_method);
                    } else if (hasToolCalls && data.route_method === 'llm' && data.response) {
                        addMessage('assistant', data.response, data.route_method);
                    }
                } else {
                    addMessage('system', `Error: ${data.error || 'Unknown error'}`);
                }
            } catch (e) {
                hideLoading(loadingId);
                addMessage('system', `Error: ${e.message}`);
            }
        }

        // ========== STOP REQUEST ==========
        function stopRequest() {
            if (abortController) {
                abortController.abort();
            }
        }

        stopBtn.addEventListener('click', stopRequest);

        // ========== ADD MESSAGE ==========
        function addMessage(type, content, routeMethod = null) {
            const div = document.createElement('div');
            div.className = 'message';

            if (type === 'user') {
                div.innerHTML = `
                    <div class="message-user">
                        <span class="message-prompt">‚ùØ</span>
                        <span class="message-content">${escapeHtml(content)}</span>
                    </div>
                `;
            } else if (type === 'assistant') {
                const routeBadge = routeMethod ?
                    `<span class="route-badge ${routeMethod}">${routeMethod === 'pattern' ? '‚ö° pattern' : 'ü§ñ llm'}</span>` : '';

                div.innerHTML = `
                    <div class="message-assistant">
                        ${formatContent(content)}
                        ${routeBadge}
                    </div>
                `;
            } else {
                div.innerHTML = `<div class="message-system">${content}</div>`;
            }

            output.appendChild(div);
            scrollToBottom();

            // Highlight code & add copy buttons
            div.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
            addCopyButtons(div);
        }

        // ========== ADD TOOL CALL ==========
        function addToolCall(tc) {
            const div = document.createElement('div');
            div.className = 'tool-call';

            const icon = TOOL_ICONS[tc.tool] || TOOL_ICONS.default;
            const truncate = (str, len = 50) => {
                if (typeof str !== 'string') str = String(str);
                return str.length > len ? str.substring(0, len) + '...' : str;
            };

            const params = Object.entries(tc.params || {})
                .map(([k, v]) => `${k}="${truncate(v)}"`)
                .join(', ');

            const isSuccess = tc.result.success !== false;
            const statusClass = isSuccess ? 'success' : 'error';
            const statusIcon = isSuccess ? '‚úì' : '‚úó';

            const resultStr = isSuccess ?
                formatToolResult(tc.tool, tc.result) :
                `<span style="color: var(--accent-red)">Error: ${escapeHtml(tc.result.error)}</span>`;

            div.innerHTML = `
                <div class="tool-header">
                    <span class="tool-icon">${icon}</span>
                    <span class="tool-name">${tc.tool}</span>
                    <span class="tool-params">(${params})</span>
                    <span class="tool-status ${statusClass}">${statusIcon}</span>
                </div>
                <div class="tool-result">${resultStr}</div>
            `;

            output.appendChild(div);
            scrollToBottom();
        }

        // ========== ADD THINKING ==========
        function addThinking(thinking) {
            const div = document.createElement('div');
            div.className = 'thinking-block';

            const content = Array.isArray(thinking) ? thinking.join('\n') : thinking;

            div.innerHTML = `
                <div class="thinking-header">
                    <span>üß†</span>
                    <span>Thinking</span>
                </div>
                <div class="thinking-content">${escapeHtml(content)}</div>
            `;

            output.appendChild(div);
            scrollToBottom();
        }

        // ========== LOADING ==========
        function showLoading(text = 'Processing...') {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'loading';
            div.innerHTML = `
                <div class="loading-spinner"></div>
                <span class="loading-dot"></span>
                <span class="loading-text status-executing">${escapeHtml(text)}</span>
            `;
            output.appendChild(div);
            scrollToBottom();
            return id;
        }

        function hideLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // ========== FORMAT CONTENT ==========
        function formatContent(content) {
            if (!content) return '';

            // Convert escaped newlines
            let text = content.replace(/\\n/g, '\n');

            // Extract code blocks
            const codeBlocks = [];
            let processed = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                const idx = codeBlocks.length;
                const langName = lang || 'plaintext';
                const escapedCode = code
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .trim();

                codeBlocks.push(`
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-block-lang">${langName}</span>
                            <button class="code-copy-btn" onclick="copyCode(this)">Copy</button>
                        </div>
                        <pre><code class="language-${langName}">${escapedCode}</code></pre>
                    </div>
                `);
                return `__CODEBLOCK_${idx}__`;
            });

            // Escape HTML
            let html = escapeHtml(processed);

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Line breaks
            html = html.replace(/\n/g, '<br>');

            // Restore code blocks
            codeBlocks.forEach((block, i) => {
                html = html.replace(`__CODEBLOCK_${i}__`, block);
            });

            return html;
        }

        // ========== FORMAT TOOL RESULT ==========
        function formatToolResult(tool, result) {
            if (tool === 'ls') {
                const items = result.items || [];
                return items.slice(0, 30).map(item => {
                    const icon = item.type === 'dir' ? 'üìÅ' : 'üìÑ';
                    return `${icon} ${escapeHtml(item.name)}`;
                }).join('<br>') + (items.length > 30 ? `<br><span style="color:var(--text-muted)">... +${items.length - 30} more</span>` : '');
            }

            if (tool === 'read') {
                const content = result.content || '';
                // Backend returns "     N: content" format ‚Äî strip the line-number prefix
                const rawLines = content.split('\n').slice(0, 100);
                const lines = rawLines.map(l => l.replace(/^\s*\d+:\s?/, ''));
                const startLine = (result.offset || 0) + 1;
                return formatDiffView(result.file_path || 'file', lines, null, 'read', startLine);
            }

            if (tool === 'grep') {
                const matches = result.matches || [];
                return matches.slice(0, 20).map(m =>
                    `<span style="color:var(--text-muted)">${escapeHtml(m.file)}:${m.line_number}:</span> ${escapeHtml(m.line)}`
                ).join('<br>');
            }

            if (tool === 'bash') {
                const stdout = result.stdout || '';
                const stderr = result.stderr || '';
                let html = stdout ? `<pre style="margin:0">${escapeHtml(stdout)}</pre>` : '';
                if (stderr) {
                    html += `<pre style="margin:0;color:var(--accent-red)">${escapeHtml(stderr)}</pre>`;
                }
                return html || '<span style="color:var(--text-muted)">(no output)</span>';
            }

            if (tool === 'edit' || tool === 'write' || tool === 'code_inject') {
                const file = result.file_path || result.file || 'file';
                const oldContent = result.old_content || '';
                const newContent = result.new_content || '';
                const startLine = result.context_start_line || 1;

                if (oldContent || newContent) {
                    return formatDiffView(file,
                        newContent ? newContent.split('\n') : [],
                        oldContent ? oldContent.split('\n') : [],
                        tool, startLine
                    );
                }
                const action = tool === 'write' ? 'written' : 'edited';
                return `<span style="color:var(--accent-green)">‚úì File ${action}: ${escapeHtml(file)}</span>`;
            }

            return `<pre style="margin:0">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
        }

        // ========== LCS DIFF ALGORITHM ==========
        function computeLCS(a, b) {
            const m = a.length, n = b.length;
            // For very large files, skip LCS and fall back to naive
            if (m * n > 500000) return null;

            const dp = Array.from({length: m + 1}, () => new Uint16Array(n + 1));
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    dp[i][j] = a[i-1] === b[j-1]
                        ? dp[i-1][j-1] + 1
                        : Math.max(dp[i-1][j], dp[i][j-1]);
                }
            }

            // Backtrack to produce diff ops
            const ops = [];
            let i = m, j = n;
            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && a[i-1] === b[j-1]) {
                    ops.push({type: 'context', oldIdx: i-1, newIdx: j-1, text: a[i-1]});
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
                    ops.push({type: 'added', newIdx: j-1, text: b[j-1]});
                    j--;
                } else {
                    ops.push({type: 'removed', oldIdx: i-1, text: a[i-1]});
                    i--;
                }
            }
            return ops.reverse();
        }

        // ========== FILE EXT ‚Üí HLJS LANGUAGE ==========
        const EXT_TO_LANG = {
            'py': 'python', 'js': 'javascript', 'ts': 'typescript', 'jsx': 'javascript',
            'tsx': 'typescript', 'go': 'go', 'rs': 'rust', 'rb': 'ruby', 'java': 'java',
            'c': 'c', 'cpp': 'cpp', 'h': 'c', 'hpp': 'cpp', 'cs': 'csharp',
            'sh': 'bash', 'bash': 'bash', 'zsh': 'bash', 'bat': 'dos', 'ps1': 'powershell',
            'sql': 'sql', 'html': 'xml', 'htm': 'xml', 'xml': 'xml', 'svg': 'xml',
            'css': 'css', 'scss': 'scss', 'less': 'less',
            'json': 'json', 'yaml': 'yaml', 'yml': 'yaml', 'toml': 'ini',
            'md': 'markdown', 'dockerfile': 'dockerfile', 'makefile': 'makefile',
            'tf': 'hcl', 'hcl': 'hcl', 'lua': 'lua', 'php': 'php', 'swift': 'swift',
            'kt': 'kotlin', 'r': 'r', 'pl': 'perl'
        };

        function getLangFromFile(filePath) {
            if (!filePath) return null;
            const name = filePath.split(/[/\\]/).pop().toLowerCase();
            if (name === 'dockerfile' || name.startsWith('dockerfile.')) return 'dockerfile';
            if (name === 'makefile' || name === 'gnumakefile') return 'makefile';
            const ext = name.includes('.') ? name.split('.').pop() : '';
            return EXT_TO_LANG[ext] || null;
        }

        // ========== DIFF VIEW ==========
        function formatDiffView(file, newLines, oldLines, action, startLine) {
            startLine = startLine || 1;
            const lang = getLangFromFile(file);
            const diffId = 'diff-' + Date.now() + '-' + Math.random().toString(36).slice(2, 6);
            let addedCount = 0, removedCount = 0;

            let html = `<div class="diff-container" id="${diffId}">
                <div class="diff-header">
                    <span class="diff-header-icon">‚óè</span>
                    <span class="diff-header-text">${action === 'read' ? 'Read' : 'Edit'}</span>
                    <span class="diff-header-file">${escapeHtml(file)}</span>
                    <div class="diff-stats">__DIFF_STATS__</div>
                </div>
                <div class="diff-content">`;

            if (action === 'read') {
                // Read mode: single line-number column, no sign column
                newLines.forEach((line, i) => {
                    html += `<div class="diff-line diff-context">
                        <span class="diff-line-number">${startLine + i}</span>
                        <span class="diff-line-content" style="padding-left:12px">${escapeHtml(line)}</span>
                    </div>`;
                });
            } else {
                // Diff mode: LCS-based
                const ops = (oldLines && oldLines.length > 0)
                    ? computeLCS(oldLines, newLines)
                    : null;

                if (ops) {
                    // Proper LCS diff with dual line numbers
                    let oldNum = startLine, newNum = startLine;
                    ops.forEach(op => {
                        if (op.type === 'context') {
                            html += `<div class="diff-line diff-context">
                                <span class="diff-line-number">${oldNum}</span>
                                <span class="diff-line-number">${newNum}</span>
                                <span class="diff-line-sign"> </span>
                                <span class="diff-line-content">${escapeHtml(op.text)}</span>
                            </div>`;
                            oldNum++; newNum++;
                        } else if (op.type === 'removed') {
                            removedCount++;
                            html += `<div class="diff-line diff-removed">
                                <span class="diff-line-number">${oldNum}</span>
                                <span class="diff-line-number"></span>
                                <span class="diff-line-sign">-</span>
                                <span class="diff-line-content">${escapeHtml(op.text)}</span>
                            </div>`;
                            oldNum++;
                        } else if (op.type === 'added') {
                            addedCount++;
                            html += `<div class="diff-line diff-added">
                                <span class="diff-line-number"></span>
                                <span class="diff-line-number">${newNum}</span>
                                <span class="diff-line-sign">+</span>
                                <span class="diff-line-content">${escapeHtml(op.text)}</span>
                            </div>`;
                            newNum++;
                        }
                    });
                } else {
                    // Fallback for very large diffs or new files (no old content)
                    newLines.forEach((line, i) => {
                        addedCount++;
                        html += `<div class="diff-line diff-added">
                            <span class="diff-line-number"></span>
                            <span class="diff-line-number">${startLine + i}</span>
                            <span class="diff-line-sign">+</span>
                            <span class="diff-line-content">${escapeHtml(line)}</span>
                        </div>`;
                    });
                }
            }

            html += '</div></div>';

            // Insert stats
            if (action !== 'read') {
                const statsHtml =
                    (addedCount ? `<span class="diff-stats-added">+${addedCount}</span> ` : '') +
                    (removedCount ? `<span class="diff-stats-removed">-${removedCount}</span>` : '');
                html = html.replace('__DIFF_STATS__', statsHtml);
            } else {
                html = html.replace('__DIFF_STATS__', '');
            }

            // Schedule syntax highlighting after DOM insertion
            if (lang) {
                setTimeout(() => {
                    const container = document.getElementById(diffId);
                    if (!container) return;
                    container.querySelectorAll('.diff-line-content').forEach(el => {
                        const code = document.createElement('code');
                        code.className = `language-${lang}`;
                        code.textContent = el.textContent;
                        el.textContent = '';
                        el.appendChild(code);
                        hljs.highlightElement(code);
                    });
                }, 0);
            }

            return html;
        }

        // ========== COPY CODE ==========
        function copyCode(btn) {
            const pre = btn.closest('.code-block-wrapper').querySelector('pre code');
            const text = pre.textContent;

            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function addCopyButtons(container) {
            // Already handled in formatContent
        }

        // ========== UTILITY ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }

        // ========== HEALTH CHECK ==========
        async function checkHealth() {
            try {
                const r = await fetch('/api/health');
                const data = await r.json();

                if (data.ollama) {
                    statusDot.classList.remove('offline');
                    statusText.textContent = 'Connected';
                    modelBadge.textContent = data.model;
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = 'Ollama offline';
                }
            } catch (e) {
                statusDot.classList.add('offline');
                statusText.textContent = 'Disconnected';
            }
        }

        checkHealth();
        setInterval(checkHealth, 30000);

        // ========== CONFIRMATION SYSTEM ==========
        function renderChoices(choices, messageId, question) {
            pendingConfirmation = { choices, messageId };
            selectedChoiceIndex = choices.findIndex(c => c.default) || 0;

            const div = document.createElement('div');
            div.id = `choices-${messageId}`;
            div.className = 'choices-container';

            div.innerHTML = `
                <div class="choices-question">${escapeHtml(question || 'Do you want to proceed?')}</div>
                <div class="choices-list">
                    ${choices.map((choice, i) => `
                        <div class="choice-item ${i === selectedChoiceIndex ? 'choice-active' : ''}"
                             data-index="${i}" data-id="${choice.id}">
                            <span class="choice-marker">${i === selectedChoiceIndex ? '>' : ' '}</span>
                            <span class="choice-number">${choice.id}.</span>
                            <span>${escapeHtml(choice.text)}</span>
                            <span class="choice-shortcut">${choice.shortcut}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="choices-hint">‚Üë‚Üì navigate ‚Ä¢ Enter select ‚Ä¢ Esc cancel ‚Ä¢ 1-3 quick select</div>
            `;

            setTimeout(() => {
                div.querySelectorAll('.choice-item').forEach(item => {
                    item.addEventListener('click', () => confirmChoice(parseInt(item.dataset.index)));
                });
            }, 0);

            output.appendChild(div);
            scrollToBottom();
        }

        function updateChoiceSelection() {
            if (!pendingConfirmation) return;
            const container = document.getElementById(`choices-${pendingConfirmation.messageId}`);
            if (!container) return;

            container.querySelectorAll('.choice-item').forEach((item, i) => {
                const isActive = i === selectedChoiceIndex;
                item.classList.toggle('choice-active', isActive);
                item.querySelector('.choice-marker').textContent = isActive ? '>' : ' ';
            });
        }

        async function confirmChoice(index) {
            if (!pendingConfirmation) return;

            const choice = pendingConfirmation.choices[index !== undefined ? index : selectedChoiceIndex];
            const messageId = pendingConfirmation.messageId;

            const container = document.getElementById(`choices-${messageId}`);
            if (container) {
                container.innerHTML = `<div style="color:var(--accent-green)">‚úì Selected: ${escapeHtml(choice.text)}</div>`;
            }

            try {
                const response = await fetch('/api/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_id: messageId,
                        choice_id: choice.id,
                        choice_text: choice.text
                    })
                });

                const data = await response.json();
                if (data.success && data.response) {
                    addMessage('assistant', data.response);
                }
            } catch (e) {
                console.error('Confirmation error:', e);
            }

            pendingConfirmation = null;
        }

        // Global keyboard handler
        document.addEventListener('keydown', (e) => {
            // Escape to stop request
            if (e.key === 'Escape' && isProcessing && !pendingConfirmation) {
                e.preventDefault();
                stopRequest();
                return;
            }

            if (!pendingConfirmation) return;

            if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedChoiceIndex = Math.max(0, selectedChoiceIndex - 1);
                updateChoiceSelection();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedChoiceIndex = Math.min(pendingConfirmation.choices.length - 1, selectedChoiceIndex + 1);
                updateChoiceSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                confirmChoice();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                const container = document.getElementById(`choices-${pendingConfirmation.messageId}`);
                if (container) container.innerHTML = `<div style="color:var(--accent-red)">‚úó Cancelled</div>`;
                pendingConfirmation = null;
            } else if (e.key >= '1' && e.key <= '9') {
                const idx = parseInt(e.key) - 1;
                if (idx < pendingConfirmation.choices.length) {
                    e.preventDefault();
                    confirmChoice(idx);
                }
            }
        });

        // ========== MODEL SELECTOR ==========
        const modelSelector = document.getElementById('model-selector');
        const modelBadgeBtn = document.getElementById('model-badge');
        const modelDropdown = document.getElementById('model-dropdown');
        const modelList = document.getElementById('model-list');
        const modelNameSpan = document.getElementById('model-name');

        let availableModels = [];

        modelBadgeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = modelSelector.classList.toggle('open');
            if (isOpen) loadModels();
        });

        document.addEventListener('click', (e) => {
            if (!modelSelector.contains(e.target)) {
                modelSelector.classList.remove('open');
            }
        });

        async function loadModels() {
            modelList.innerHTML = '<div class="model-dropdown-loading">Loading...</div>';
            try {
                const r = await fetch('/api/models');
                const data = await r.json();
                availableModels = data.models || [];
                const current = data.current || '';

                if (availableModels.length === 0) {
                    modelList.innerHTML = '<div class="model-dropdown-loading">No models found</div>';
                    return;
                }

                // Group by provider
                const ollama = availableModels.filter(m => m.provider === 'ollama');
                const claude = availableModels.filter(m => m.provider === 'anthropic');

                let html = '';

                if (ollama.length > 0) {
                    html += '<div class="model-dropdown-header">üñ•Ô∏è Ollama (Local)</div>';
                    html += ollama.map(m => renderModelItem(m, current)).join('');
                }

                if (claude.length > 0) {
                    html += '<div class="model-dropdown-header">‚òÅÔ∏è Claude (Anthropic API)</div>';
                    html += claude.map(m => renderModelItem(m, current)).join('');
                }

                modelList.innerHTML = html;
            } catch (e) {
                modelList.innerHTML = '<div class="model-dropdown-loading">Failed to load models</div>';
            }
        }

        function renderModelItem(m, current) {
            const isActive = m.name === current;
            const sizeMB = m.size ? (m.size / 1024 / 1024 / 1024).toFixed(1) + ' GB' : '';
            const params = m.params || '';
            const providerIcon = m.provider === 'anthropic' ? '‚òÅÔ∏è' : '';
            const meta = [params, sizeMB].filter(Boolean).join(' ‚Ä¢ ');
            const escapedName = m.name.replace(/'/g, "\\'");
            return `
                <div class="model-item ${isActive ? 'active' : ''}"
                     data-model="${m.name}"
                     onclick="selectModel('${escapedName}')">
                    <span class="model-item-check">${isActive ? '‚úì' : providerIcon}</span>
                    <div class="model-item-info">
                        <div class="model-item-name">${m.name}</div>
                        ${meta ? `<div class="model-item-meta">${meta}</div>` : ''}
                    </div>
                </div>
            `;
        }

        async function selectModel(name) {
            modelSelector.classList.remove('open');

            try {
                const r = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: name })
                });
                const data = await r.json();

                if (data.success) {
                    modelNameSpan.textContent = name.split(':')[0];
                    addMessage('system', `Model switched: ${data.old_model} ‚Üí ${data.new_model}`);
                }
            } catch (e) {
                addMessage('system', `Failed to switch model: ${e.message}`);
            }
        }

        // ========== FULLSCREEN API ==========
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else {
                document.exitFullscreen();
            }
        }

        fullscreenBtn.addEventListener('click', toggleFullscreen);

        document.addEventListener('fullscreenchange', () => {
            const isFS = !!document.fullscreenElement;
            fullscreenBtn.textContent = isFS ? '\u2716' : '\u26F6';
            fullscreenBtn.title = isFS ? 'Exit fullscreen (F11)' : 'Toggle fullscreen (F11)';
            document.body.classList.toggle('compact-mode', isFS);
        });

        // F11 override ‚Äî use Fullscreen API instead of browser default
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        // ========== PWA INSTALL ==========
        const installBtn = document.getElementById('install-btn');
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            if (result.outcome === 'accepted') {
                installBtn.style.display = 'none';
            }
            deferredPrompt = null;
        });

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            deferredPrompt = null;
        });

        // ========== SERVICE WORKER REGISTRATION ==========
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {});
        }

        // ========== STANDALONE DETECTION ==========
        if (window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true) {
            document.body.classList.add('compact-mode');
        }

        // Focus input
        input.focus();

        // Auto-test: localhost:5002?test=multiline
        (async function autoTest() {
            const params = new URLSearchParams(window.location.search);
            const testType = params.get('test');
            if (testType === 'multiline' || testType === 'nested') {
                // Nested indentation test: replace 4-level deep block (lines 22-31)
                const oldStr = testType === 'nested'
                    ? "                    if check[\"type\"] == \"http\":\n                        container[\"health\"] = {\n                            \"endpoint\": check[\"path\"],\n                            \"interval\": 30\n                        }\n                    elif check[\"type\"] == \"tcp\":\n                        container[\"health\"] = {\n                            \"port\": check[\"port\"],\n                            \"timeout\": 10\n                        }"
                    : "def hello():\n    \"\"\"Say hello\"\"\"\n    print(\"Hello World\")\n    return True";
                const newStr = testType === 'nested'
                    ? "                    if check[\"type\"] == \"http\":\n                        container[\"health\"] = {\n                            \"endpoint\": check[\"path\"],\n                            \"interval\": check.get(\"interval\", 30),\n                            \"retries\": check.get(\"retries\", 3),\n                            \"timeout\": 5\n                        }\n                    elif check[\"type\"] == \"tcp\":\n                        container[\"health\"] = {\n                            \"port\": check[\"port\"],\n                            \"timeout\": check.get(\"timeout\", 10),\n                            \"retries\": 3\n                        }\n                    elif check[\"type\"] == \"exec\":\n                        container[\"health\"] = {\n                            \"command\": check[\"cmd\"],\n                            \"interval\": 60\n                        }"
                    : "def hello(name=\"World\"):\n    \"\"\"Say hello to someone\"\"\"\n    greeting = f\"Hello {name}\"\n    print(greeting)\n    return greeting";
                const label = testType === 'nested'
                    ? 'nested edit: replace health_check block (10 lines ‚Üí 18 lines, 4-level indent)'
                    : 'multiline edit: replace hello() function (4‚Üí5 lines)';
                addMessage('user', label);
                const loadId = showLoading('Running edit test...');
                try {
                    const r = await fetch('/api/test-multiline-edit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            file_path: '_test_diff.py',
                            old_string: oldStr,
                            new_string: newStr
                        })
                    });
                    const d = await r.json();
                    hideLoading(loadId);
                    if (d.tool_calls) {
                        for (const tc of d.tool_calls) addToolCall(tc);
                    }
                    // Scroll diff container to top so full diff is visible
                    setTimeout(() => {
                        const dc = document.querySelector('.diff-content');
                        if (dc) dc.scrollTop = 0;
                        window.scrollTo(0, 0);
                    }, 200);
                } catch(e) {
                    hideLoading(loadId);
                    addMessage('system', 'Test error: ' + e.message);
                }
            }
        })();
    </script>
</body>
</html>
