<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QwenAgent</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #161b22;
            padding: 8px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title { color: #58a6ff; font-weight: 600; }
        .title span { color: #8b949e; font-weight: 400; font-size: 11px; margin-left: 8px; }

        .status-bar {
            display: flex;
            gap: 16px;
            font-size: 11px;
        }

        .status { color: #3fb950; }
        .status.busy { color: #d29922; }
        .status.error { color: #f85149; }

        .badge {
            background: #21262d;
            padding: 2px 8px;
            border-radius: 12px;
            color: #8b949e;
        }

        .output {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .msg { margin-bottom: 12px; }

        .msg.user {
            color: #58a6ff;
            display: flex;
        }
        .msg.user::before {
            content: '‚ùØ';
            color: #a371f7;
            margin-right: 8px;
            font-weight: bold;
        }

        .msg.bot { color: #c9d1d9; padding-left: 16px; }
        .msg.sys { color: #8b949e; font-style: italic; }
        .msg.err { color: #f85149; }

        .msg.tool {
            background: #161b22;
            border-left: 3px solid #d29922;
            padding: 8px 12px;
            margin: 8px 0;
            font-size: 12px;
        }

        .msg.tool .tool-name { color: #d29922; font-weight: 600; }

        .msg.result {
            background: #161b22;
            border-left: 3px solid #3fb950;
            padding: 8px 12px;
            margin: 8px 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .msg.thinking {
            color: #a371f7;
            font-size: 12px;
            padding-left: 16px;
        }
        .msg.thinking::before { content: 'üí≠ '; }

        .input-area {
            background: #161b22;
            border-top: 1px solid #30363d;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt { color: #a371f7; font-weight: bold; }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: #c9d1d9;
            font: inherit;
            outline: none;
        }

        #input::placeholder { color: #484f58; }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #8b949e;
        }

        .mode-toggle input { cursor: pointer; }
        .mode-toggle.active { color: #a371f7; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">
            QwenAgent
            <span>Autonomous Code Agent</span>
        </div>
        <div class="status-bar">
            <span class="badge" id="model">qwen2.5-coder:3b</span>
            <span class="badge" id="route-method">-</span>
            <span class="status" id="status">ready</span>
        </div>
    </div>

    <div class="output" id="output">
        <div class="msg sys">QwenAgent - Like Claude Code, but local</div>
        <div class="msg sys">Tools: bash, read, write, edit, glob, grep, ls, git</div>
        <div class="msg sys">Type /help for commands, [deep] for Chain-of-Thought mode</div>
    </div>

    <div class="input-area">
        <span class="prompt">‚ùØ</span>
        <input id="input" placeholder="Type a message..." autofocus>
        <label class="mode-toggle" id="deep-toggle">
            <input type="checkbox" id="deep-mode">
            <span>Deep</span>
        </label>
    </div>

    <script>
        const out = document.getElementById('output');
        const inp = document.getElementById('input');
        const stat = document.getElementById('status');
        const routeMethod = document.getElementById('route-method');
        const deepMode = document.getElementById('deep-mode');
        const deepToggle = document.getElementById('deep-toggle');

        let hist = [], histIdx = 0;

        function add(text, cls = 'bot') {
            const d = document.createElement('div');
            d.className = 'msg ' + cls;
            d.textContent = text;
            out.appendChild(d);
            out.scrollTop = out.scrollHeight;
            return d;
        }

        function addTool(name, params, result) {
            // Tool call
            const toolDiv = document.createElement('div');
            toolDiv.className = 'msg tool';
            toolDiv.innerHTML = `<span class="tool-name">${name}</span>: ${JSON.stringify(params)}`;
            out.appendChild(toolDiv);

            // Result
            if (result) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'msg result';
                let text = '';
                if (result.output) text = result.output;
                else if (result.content) text = result.content;
                else if (result.items) text = result.items.map(i => `${i.type === 'dir' ? '[D]' : '[F]'} ${i.name}`).join('\n');
                else if (result.files) text = result.files.join('\n');
                else if (result.results) text = result.results.map(r => r.content).join('\n');
                else if (result.error) text = 'Error: ' + result.error;
                else text = JSON.stringify(result, null, 2);
                resultDiv.textContent = text.substring(0, 5000);
                out.appendChild(resultDiv);
            }
            out.scrollTop = out.scrollHeight;
        }

        async function send(text) {
            add(text, 'user');

            // Commands
            if (text.startsWith('/')) {
                const cmd = text.slice(1).split(' ')[0];
                if (cmd === 'help') {
                    add('Commands: /help /clear /model /stats /test', 'sys');
                    add('Features: [deep] prefix for Chain-of-Thought', 'sys');
                    add('Examples: read package.json, list files, git status', 'sys');
                } else if (cmd === 'clear') {
                    out.innerHTML = '';
                } else if (cmd === 'stats') {
                    const r = await fetch('/api/status');
                    const data = await r.json();
                    add(JSON.stringify(data.stats, null, 2), 'sys');
                } else if (cmd === 'test') {
                    runTests();
                } else {
                    add('Unknown: ' + cmd, 'err');
                }
                return;
            }

            stat.textContent = 'thinking...';
            stat.className = 'status busy';

            try {
                const r = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: text,
                        deep_mode: deepMode.checked
                    })
                });
                const data = await r.json();

                // Update route method
                routeMethod.textContent = data.route_method || '-';

                // Show thinking
                if (data.thinking && data.thinking.length > 0) {
                    for (const t of data.thinking) {
                        add(t, 'thinking');
                    }
                }

                // Show tool calls
                if (data.tool_calls) {
                    for (const tc of data.tool_calls) {
                        addTool(tc.tool, tc.params, tc.result);
                    }
                }

                // Show response
                if (data.response) {
                    add(data.response, 'bot');
                } else if (data.error) {
                    add(data.error, 'err');
                }

            } catch (e) {
                add('Error: ' + e.message, 'err');
            }

            stat.textContent = 'ready';
            stat.className = 'status';
        }

        async function runTests() {
            add('Running DevOps tests...', 'sys');
            const tests = [
                'list files in current directory',
                'read README.md',
                'git status',
                'find all .py files'
            ];
            for (const test of tests) {
                add(`Test: ${test}`, 'sys');
                await send(test);
            }
            add('Tests complete', 'sys');
        }

        // Deep mode toggle
        deepMode.onchange = () => {
            deepToggle.classList.toggle('active', deepMode.checked);
        };

        inp.onkeydown = e => {
            if (e.key === 'Enter' && inp.value.trim()) {
                hist.push(inp.value);
                histIdx = hist.length;
                send(inp.value.trim());
                inp.value = '';
            } else if (e.key === 'ArrowUp' && histIdx > 0) {
                inp.value = hist[--histIdx] || '';
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                inp.value = hist[++histIdx] || '';
                e.preventDefault();
            }
        };

        document.onkeydown = e => {
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                out.innerHTML = '';
            }
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                deepMode.checked = !deepMode.checked;
                deepToggle.classList.toggle('active', deepMode.checked);
            }
        };

        document.onclick = e => {
            if (e.target.tagName !== 'INPUT') inp.focus();
        };

        // Check status
        fetch('/api/status').then(r => r.json()).then(data => {
            if (data.status === 'ok') {
                document.getElementById('model').textContent = data.model;
            }
        });
    </script>
</body>
</html>
